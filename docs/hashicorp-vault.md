# Hashicorp Vault configuration

The `kerying_component` or the `keyring_plugin` communicates with Hashicorp Vault for back-end storage.

2. Prepare the certificate and key files for a secure HTTPS connection to the Hashicorp Vault server. You need a custom CA certificate, a private key, a certificate for the Hashicorp Vault server instance, and a certificate for the server instance. You can use OpenSSL to generate these files or use existing ones. 

5. Configure the options on your server. You must specify the URL of the Hashicorp Vault server, the path of the CA certificate file, the role ID and secret ID, and optionally other parameters such as the secrets mount point, the token TTL, and the key prefix. You can set these options using system variables or adding them to the my.cnf file. 

6. Restart your server to apply the changes.

Verify that the component or plugin is loaded and working.

!!! admonition "See also"

    [Hashicorp Documentation: Installing Vault](https://www.vaultproject.io/docs/install/index.html)
    [Hashicorp Documentation: Production Hardening](https://learn.hashicorp.com/vault/operations/production-hardening)

## keyring_vault_config File 

After installing the plugin, you must also point the
`keyring_vault_config` variable to the keyring_vault
configuration file.

The keyring_vault_config file has the following information:

* `vault_url` - the Vault server address

* `secret_mount_point` - the mount point name where the keyring_vault stores the keys.

* `secret_mount_point_version` - the `KV Secrets Engine version (kv or kv-v2)` used. Implemented in Percona Server for MySQL 8.0.23-14.

* `token` - a token generated by the Vault server

* `vault_ca [optional]` - if the machine does not trust the Vault’s CA certificate, this variable points to the CA certificate used to sign the Vault’s certificates

An example of a configuration file:

```text
vault_url = https://vault.public.com:8202
secret_mount_point = secret
secret_mount_point_version = AUTO
token = {randomly-generated-alphanumeric-string}
vault_ca = /data/keyring_vault_confs/vault_ca.crt
```

!!! warning

    Each `secret_mount_point` must be used by only one server. If multiple servers use the same secret_mount_point, the behavior is unpredictable.

The first time a key is fetched from a keyring, the keyring_vault
communicates with the Vault server to retrieve the key type and data.

## secret_mount_point_version information

Implemented in Percona Server for MySQL 8.0.23-14, the `secret_mount_point_version`
can be either a `1`, `2`, `AUTO`, or the `secret_mount_point_version`
parameter is not listed in the configuration file.

| Value            | Description                                          |       
|----------------- | ---------------------------------------------------- | 
| 1                | Works with `KV Secrets Engine - Version 1 (kv)`. When forming key operation URLs, the `secret_mount_point` is always used without any transformations. For example, to return a key named `skey`, the URL is <vault_url>/v1/<secret_mount_point>/skey  |
| 2                | Works with `KV Secrets Engine - Version 2 (kv)` The initialization logic splits the `secret_mount_point` parameter into two parts:<ul><li>The `mount_point_path` - the mount path under which the Vault Server secret was created</li><li>The `directory_path` - a virtual directory suffix that can be used to create virtual namespaces with the same real mount point</li></ul> For example, both the `mount_point_path` and the `directory_path` are needed to form key access URLs: <vault_url>/v1/<mount_point_path/data/<directory_path>/skey |
| AUTO | An autodetection mechanism probes and determines if the secrets engine version is `kv` or `kv-v2` and based on the outcome will either use the `secret_mount_point` as is, or split the `secret_mount_point` into two parts.|
| Not listed| If the `secret_mount_point_version` is not listed in the configuration file, the behavior is the same as `AUTO`.|

If you set the `secret_mount_point_version` to `2` but the path pointed
by `secret_mount_point` is based on `KV Secrets Engine - Version 1 (kv)`,
an error is reported, and the plugin fails to initialize.

If you set the `secret_mount_point_version` to `1` but the path pointed
by `secret_mount_point` is based on `KV Secrets Engine -
Version 2 (kv-v2)`, the plugin initialization succeeds but any MySQL
keyring-related operations fail.